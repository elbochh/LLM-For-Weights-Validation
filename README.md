# LLM-For-Weights-Validation

This repository implements the Large Language Model (LLM) layer of our hackathon project. It uses a Retrieval-Augmented Generation (RAG) pipeline to analyze management discussions (10-K/10-Q) and macroeconomic context, scoring long-short stock pairs across five fundamental dimensions (growth, cash generation, earnings outlook, downside risk, macro sensitivity).
The goal is to validate or swap portfolio weights generated by an external Reinforcement Learning model, ensuring the final portfolio reflects both quantitative and qualitative insights.

# Overview
This pipeline processes monthly portfolio weight data to:
1. Calculate position changes between consecutive months
2. Link stocks to their textual filings (management discussions)
3. Merge financial characteristics and sector data
4. Pair opposite-weight stocks based on financial similarity
5. Use LLM-based RAG to score pairs and recommend weight swaps

# Key Features
1. Data Leakage Prevention
   All financial data merges use date <= target_date
   Filing dates are from most recent non-leakage filing
   Time-aware lookups throughout
2. Stock Pairing Strategy
   Pairs positive-weight stocks with most similar negative-weight stocks
   Similarity based on: ret_12_1, log(market_cap), niq_su, ivol_ff3_21d, niq_at
   Matching within same country and sector
   Uses Euclidean distance with standardized features
3. RAG-Based Scoring
   Uses Mistral LLM to score pairs based on:
   Management discussion text (summarized)
   Macro economic reports
   Financial metrics
   Conservative swap logic: only recommends swap when very confident
   Outputs structured JSON with 5-dimensional scores
4. Text Summarization
   Summarizes long management discussion texts while preserving:
   Forward-looking language
   Risk qualifiers
   Sentiment/tonality
   Numbers and percentages
   Named entities
   Chunking for texts exceeding model context window
   Caching to avoid redundant API calls


# Why This Matters

This pipeline represents a new generation of AI-driven portfolio intelligence, bridging the gap between data-driven models and qualitative financial reasoning.

Reinforcement Learning (RL) captures market dynamics and quantitative patterns, learning optimal portfolio weights from historical signals.

Large Language Models (LLMs) extract narrative insights from corporate filings and macroeconomic reports — signals that traditional quantitative models often overlook.

Together, they form a hybrid decision system that enhances portfolio robustness, transparency, and forward-looking adaptability — combining the precision of data with the intuition of context.

#Core Modules
calculate_position_changes.py: Calculate weight transitions between months
map_filings_to_transitions.py: Link companies to their filings
merge_sector_and_financials.py: Merge financial characteristics
pair_stocks.py: Pair stocks by financial similarity
filing_retriever.py: Retrieve management discussion text
macro_loader.py: Load macro economic reports
rag_scorer.py: RAG-based scoring using Mistral LLM
mgmt_summarizer.py: Summarize management discussion text
process_pairs.py: Full pipeline for processing pairs

# Dependencies

### Python Packages
pip install pandas numpy scikit-learn sentence-transformers textblob requests
### Required Files
- **Weight files**: Monthly CSV files with columns `id`, `weight`, `date`
- **Linktable**: `cik_gvkey_linktable_USA_only.csv` (gvkey, cik, datadate, iid, etc.)
- **Financial data**: `ret_sample_preprocessed_indneu.parquet` (gvkey, date, sector, financial metrics)
- **Text data**: Pickle files in `text_data/` directory (e.g., `text_us_2017.pkl`)
- **Macro reports**: Markdown files in `macro reports/` directory (e.g., `2017-02.md`)

### API Configuration
- **Mistral API**: Required for RAG scoring (model: `open-mistral-7b`)
- API key should be set in the configuration

## Quick Start

### Option 1: Run Full Pipeline (US Stocks)
python run_pipeline_us_yearly.pyThis will:
- Process `weights_US.csv` into monthly files
- Calculate all transitions
- Link to filings and financial data
- Generate pair recommendations year by year
- Output CSV files: `pair_recommendations_US/recommendations_YYYY.csv`

### Option 2: Run Individual Steps

## Step 1: Calculate Position Changesh
python calculate_position_changes.py**Input**: `Weights/` directory  
**Output**: `Position_Changes/` directory

---

## Step 2: Map Filings to Transitions
python map_filings_to_transitions.py**Input**: `Position_Changes/` directory  
**Output**: `Position_Changes_With_Links/` directory

---

## Step 3: Merge Financial Data
python merge_sector_and_financials.py**Input**: `Position_Changes_With_Links/` directory  
**Output**: `Position_Changes_With_Links/` directory (enhanced)

---

## Step 4: Process Pairs & Generate Recommendations
python process_pairs.py**Input**: `Position_Changes_With_Links/` directory  
**Output**: `pair_recommendations/` directory


